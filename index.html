<link rel="stylesheet" href="style.css">

<script>
    "use strict";

    function codeFormatter(text) {

        // format text appropriately

        let clean_text = text.split("");

        // set the indent level
        let indent = 0;
        let indent_space = 2;
        let output = "";
        let error_message = "";

        let inside_quote = false;



        clean_text.forEach((character, index) => {

            // don't indent if inside quotes
            if (character == "\"") {
                if (inside_quote) {
                    inside_quote = false;
                } else {
                    inside_quote = true;
                }
            }

            if (!(inside_quote)) {
                if (character == "(") {
                    indent += indent_space;
                    output += "(" + "\n" + " ".repeat(indent);
                } else if (character == ")") {
                    indent -= indent_space;
                    if (indent >= 0) {
                        output += "\n" + " ".repeat(indent) + ")";
                    } else {
                        error_message = "Your code has <strong>too many</strong> closing brackets. It has <strong>" + Math.abs(indent) / indent_space + " extra</strong> closing bracket(s)."
                    }
                } else if (character == ",") {
                    output += "," + "\n" + " ".repeat(indent - 1);

                } else if (character == " ") {
                    // check if the last word was one which should trigger linebreak
                    let text_so_far = text.substring(0, index);
                    let last_space_match = text_so_far.match(/\s(?!.*\s)/);
                    if (last_space_match) {
                        let last_space_index = last_space_match["index"];
                        let last_word = text.substring(last_space_index + 1, index).trim();
                        if (last_word == "then") {
                            indent += indent_space;
                            output += "\n" + " ".repeat(indent)
                        } else if (last_word == "else") {
                            indent -= indent_space;
                            if (indent >= 0) {
                                output += "\n" + " ".repeat(indent);
                            } else {
                                error_message = "Your code has a 'then' statement but is missing an 'else'."
                            }
                        } else {
                            output += character;
                        }
                    } else {
                        output += character;
                    }
                } else {
                    output += character;
                }
            } else {
                output += character;
            }
        })

        if (indent > 0) {
            error_message = "Your code is <strong>missing</strong> some closing brackets. It is <strong>missing " + indent / indent_space + "</strong> closing bracket(s)."
        }

        document.querySelector('#code-ouput').value = output
        if (error_message != "") {
            document.querySelector('#error-message').innerHTML = error_message;
            document.querySelector('#error-message').style.display = 'block';
        } else {
            document.querySelector('#error-message').innerHTML = '';
            document.querySelector('#error-message').style.display = 'none';
        }
    }

    function selectOutput() {
        document.querySelector('#code-ouput').select()
    }

    function seeExample() {
        let example_text = "function1(function2(var, var))"
        document.querySelector('#code-input').value = example_text
        codeFormatter(example_text);
    }
</script>
<html>

<head>
    <title>Code indenter</title>
    <meta charset="utf-8">
</head>

<body>
    <div class="container">
        <h1>CE code indenter!</h1>
        <ul>
            <li>
                <div class="inner-container">
                    <label for="code-input">Your input here:</label>
                    <textarea name="Your input here" id="code-input" cols="30" rows="10"
                        onkeyup="javascript:codeFormatter(this.value)"
                        placeholder="function1(function2(var))"></textarea>
                </div>
            </li>
            <li>
                <div class="inner-container">
                    <label for="code-output">Your output will appear here:</label>
                    <textarea name="Your output here" id="code-ouput" cols="30" rows="10" readonly></textarea>
                </div>
            </li>
        </ul>
        <p id="error-message" title="Error message will appear here" aria-label="Error message"></p>
        <div class="button-container">
            <button onclick="javascript:seeExample()">See example</button>
            <button onclick="javascript:selectOutput()">Select output text</button>
        </div>
    </div>
    <footer>
        <p>Made by <a href="https://twitter.com/kgeorgiadis_law" target="_blank">Konstantinos Georgiadis</a> under MIT
            License. Source code <a href="https://github.com/KGeorgiadis-law/ce-formatter" target="_blank">here</a>.</p>
    </footer>
</body>

</html>