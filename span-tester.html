<link rel="stylesheet" href="style.css">
<script>
    "use strict";

    function spanTester(text) {
        let clean_text = text.split("");
        let error_message = "";
        let bracket_pairs_indices = {};

        let counter = 0;

        clean_text.forEach((character, index) => {
            if (character == "<") {
                if (!(counter in bracket_pairs_indices)) {
                    bracket_pairs_indices[counter] = []
                };

                bracket_pairs_indices[counter].push(index);

                counter++;

            } else if (character == ">") {
                if (counter > 0) {
                    counter--;
                    bracket_pairs_indices[counter].push(index);
                } else {
                    error_message = "Your text contains <strong>extra closing</strong> brackets.";
                }
            }
        });

        // // sanity check
        // console.log(bracket_pairs_indices);

        window.all_indices = [];

        // flatten bracket_pairs_indices by adding all values to the same array
        Object.values(bracket_pairs_indices).forEach(v => all_indices = all_indices.concat(v))

        window.all_spans = []; 
        let i = 0;

        while (i < all_indices.length) {
            all_spans.push(text.substring(all_indices[i], all_indices[i + 1] + 1).replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll("\n", "<br/>"));
            i += 2;
        }

        text = text.replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll("\n", "<br/>");

        all_spans.forEach((span, index) => {

            // with thanks to https://stackoverflow.com/a/1484514
            function getRandomColor() {
                var letters = '0123456789ABCDEF';
                var color = '#';
                for (var i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                
                // functions to determine whether background is light or dark
                // https://awik.io/determine-color-bright-dark-using-javascript/
                
                // convert HEX to RGB: http://gist.github.com/983661
                let rgb_color = +("0x" + color.slice(1).replace(color.length < 5 && /./g, '$&$&'));

                let r = rgb_color >> 16;
                let g = rgb_color >> 8 & 255;
                let b = rgb_color & 255;
                
                // HSP equation from http://alienryderflex.com/hsp.html
                let hsp = Math.sqrt(
                    0.299 * (r * r) +
                    0.587 * (g * g) +
                    0.114 * (b * b)
                );

                // Using the HSP value, determine whether the color is light or dark
                let color_is_bright = hsp > 127.5
                
                return [color, color_is_bright];
            }

            let colour, colour_is_bright, text_colour;
            [colour, colour_is_bright] = getRandomColor();
    
            if (colour_is_bright) {
                text_colour = 'white';
            } else {
                text_colour = 'black';
            }
            
            text = text.replaceAll(span, `<span id='converted_text_${index}_SPAN' style='background-color:${colour}; color:${text_colour}; overflow:inherit'>${span}</span>`)
        })

        document.querySelector('#code-ouput').innerHTML = text;

        // let bracket_difference = opening_brackets.length - closing_brackets.length

        // let span_list = [];

        // if (bracket_difference == 0) {

        //     // do things
        //     let opening_brackets_index = 0; 
        //     let closing_brackets_index = 0;
        //     while (opening_brackets_index < opening_brackets.length) {
        //         closing_brackets_index--

        //         let start_index = opening_brackets[opening_brackets_index];
        //         let stop_index = closing_brackets[closing_brackets_index];

        //         span_list.push(text.substring(start_index, stop_index));

        //         opening_brackets_index++
        //     }

        //     console.log({span_list})

        // } else if (bracket_difference > 0) {
        //     error_message = "Your text contains <strong>" + bracket_difference + " extra opening</strong> brackets.";
        // } else if (bracket_difference < 0) {
        //     error_message = "Your text contains <strong>" + Math.abs(bracket_difference) + " extra closing</strong> brackets.";
        // }

        if (error_message != "") {
            document.querySelector('#error-message').innerHTML = error_message;
            document.querySelector('#error-message').style.display = 'block';
        } else {
            document.querySelector('#error-message').innerHTML = '';
            document.querySelector('#error-message').style.display = 'none';
        }
    }

</script>
<html>

<head>
    <title>Span tester</title>
    <meta charset="utf-8">
</head>

<body>
    <div class="container">
        <h1>Span tester!</h1>
        <ul>
            <li>
                <div class="inner-container">
                    <label for="code-input">Your input here:</label>
                    <textarea name="Your input here" id="code-input" cols="30" rows="10"
                        onkeyup="javascript:spanTester(this.value)"
                        placeholder="<helloHello><not helloHi> there!"></textarea>
                </div>
            </li>
            <li>
                <div class="inner-container">
                    <label for="code-output">Your output will appear here:</label>
                    <div name="Your output here" id="code-ouput"></div>
                </div>
            </li>
        </ul>
        <p id="error-message" title="Error message will appear here" aria-label="Error message"></p>
        <div class="button-container">
            <button onclick="javascript:seeExample()">See example</button>
            <button onclick="javascript:selectOutput()">Select output text</button>
        </div>
    </div>
    <footer>
        <p>Made by <a href="https://twitter.com/kgeorgiadis_law" target="_blank">Konstantinos Georgiadis</a> under MIT
            License. Source code <a href="https://github.com/KGeorgiadis-law/contract-express-formatter"
                target="_blank">here</a>.</p>
    </footer>
</body>

</html>
